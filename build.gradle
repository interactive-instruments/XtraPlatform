buildscript {  
    repositories {
        mavenCentral() 
        jcenter()
        maven {
            url "https://plugins.gradle.org/m2/"
        }
        maven {
            url "https://dl.bintray.com/iide/maven"
        }
    } 
    dependencies {
        classpath group: 'de.interactive_instruments', name: 'gradle-plugin-osgi-ipojo', version: '1.12.1.26'
        classpath "gradle.plugin.nl.javadude.gradle.plugins:license-gradle-plugin:0.14.0"
        classpath 'com.jfrog.bintray.gradle:gradle-bintray-plugin:1.6'
    } 
}

allprojects {
    apply plugin: 'java'
    apply plugin: "license"
    apply plugin: 'maven-publish'
    apply plugin: 'com.jfrog.bintray'

    sourceCompatibility = 1.7

    license {
        header rootProject.file('gradle/license-header')
        strictCheck true
        excludes([
                "**/*.mustache",
                "**/*.png",
                "**/*.ico",
                "**/*.xcf",
                "**/*.json"])
        ext.year = Calendar.getInstance().get(Calendar.YEAR)
        ext.name = "interactive instruments GmbH"
    }
    
    repositories {     
        mavenLocal()
        mavenCentral()
        jcenter()
        maven {
            url "http://maven.forgerock.org/repo/repo"
        }
        maven {
            url 'http://oss.sonatype.org/content/repositories/snapshots'
        }
        maven {
            url "https://dl.bintray.com/iide/maven"
        }
    }
    
    dependencies {    
        testCompile group: 'org.testng', name: 'testng', version: '6.8.5'
        testCompile group: 'junit', name: 'junit', version: '4.12'
        testCompile group: 'org.mockito', name: 'mockito-core', version: '1.9.5'
    }
    
    test {
        useTestNG()
        options {
            includeGroups 'default'
            /* if you want to run tests for debugging purposes that are not part
            of the continuous integration, put them in the "debug"-group and
            uncomment the following line just in your local working copy
             */
            //includeGroups 'debug'
            //includeGroups 'performance'
            //includeGroups 'integration'
        }
        testLogging.showStandardStreams = true
        reports.html.enabled = true
    
    }
    
    // aggregated javadoc
    afterEvaluate { project ->
        rootProject.javadoc {
            classpath += project.sourceSets.main.compileClasspath
            source += project.sourceSets.main.allJava
        }
    }   
}

task testReport(type: TestReport) {
    destinationDir = file("$buildDir/reports/allTests")
    // Include the results from the `test` task in all subprojects
    reportOn subprojects*.test
}
test.finalizedBy testReport




version = '1.0.0'

configurations {
    cfg
    bundles {
        transitive = false
    }
    bundles2 {
        transitive = false
    }
    bundles3 {
        transitive = false
    }

    provided {
        transitive = false
    }
    compile.extendsFrom provided
}

ext {
    ignoreBundles = ['xtraplatform-runtime']
}

dependencies {
    cfg files("$buildDir/cfg")   
    
    /*provided group: 'org.slf4j', name: 'osgi-over-slf4j', version: '1.7.6'
    
    provided group: 'org.apache.felix', name: 'org.apache.felix.configadmin', version: '1.8.0'
    provided group: 'org.apache.felix', name: 'org.apache.felix.eventadmin', version: '1.3.2'
    provided group: 'org.apache.felix', name: 'org.apache.felix.fileinstall', version: '3.5.0'
    
    provided group: 'org.apache.felix', name: 'org.apache.felix.ipojo', version: '1.12.1'
    provided group: 'org.apache.felix', name: 'org.apache.felix.ipojo.handler.eventadmin', version: '1.8.0'
    provided group: 'org.apache.felix', name: 'org.apache.felix.ipojo.handler.whiteboard', version: '1.6.0'
    provided group: 'org.apache.felix', name: 'org.apache.felix.ipojo.handler.extender', version: '1.4.0'
    
    provided group: 'org.apache.felix', name: 'org.apache.felix.http.bridge', version: '2.2.2'
    provided group: 'org.apache.felix', name: 'org.apache.felix.http.whiteboard', version: '2.2.2'
    
    
    
    provided group: 'commons-fileupload', name: 'commons-fileupload', version: '1.3.1'
    provided group: 'commons-io', name: 'commons-io', version: '2.4'
    provided group: 'org.apache.felix', name: 'org.apache.felix.webconsole', version: '4.2.2'
    provided group: 'org.apache.felix', name: 'org.apache.felix.ipojo.webconsole', version: '1.7.0'
    provided group: 'org.apache.felix', name: 'org.apache.felix.webconsole.plugins.memoryusage', version: '1.0.4'
    */
    provided subprojects.findAll { [] == ignoreBundles.findAll { it2 -> it.name =~ it2 } }
    
    provided project(':xtraplatform-dropwizard')

    //compile subprojects
}


allprojects {
    jar {
        manifest {
            attributes("Implementation-Title": project.name, "Implementation-Version": project.version)
        }
    }

    configurations {
        embedded
        provided
        compile.extendsFrom embedded
        compile.extendsFrom provided
    }
} 

subprojects {
    apply plugin: 'osgi-ipojo'
    version = '1.0.0'
    
    /*configurations {
        provided
    }
    
    sourceSets {
        main.compileClasspath += configurations.provided
    }
 
    dependencies {
        provided rootProject
        testCompile rootProject
    }*/

    dependencies {
    provided 'com.google.guava:guava:17.0'

        provided group: 'org.slf4j', name: 'slf4j-api', version: '1.7.6'
    provided group: 'ch.qos.logback', name: 'logback-classic', version: '1.1.3'
    provided group: 'ch.qos.logback', name: 'logback-core', version: '1.1.3'

        provided group: 'org.osgi', name: 'org.osgi.compendium', version: '4.2.0'
        provided group: 'org.apache.felix', name: 'org.apache.felix.framework', version: '4.4.1'
        provided group: 'org.apache.felix', name: 'org.apache.felix.ipojo', version: '1.12.1'
    }
    
    jar {
        manifest { 
            instruction '-removeheaders', 'Bnd-LastModified'
            instructionReplace "Bundle-SymbolicName",project.name.replaceAll('-', '.')
        }
    }
    
    /*task deploy(type: Copy) {
        from jar
        into new File(devel.bundlesDir, 'platform')
    }
    
    task undeploy(type: Delete) {
        delete new File(new File(devel.bundlesDir, 'platform'), jar.archiveName)
    }
    
    if ([] == ignoreBundles.findAll { it2 -> project.name =~ it2 }) {
        jar.finalizedBy deploy
    }
    else {
        jar.finalizedBy undeploy
    }*/

    task sourceJar(type: Jar) {
        from sourceSets.main.allSource
    }

    publishing {
        publications {
            maven(MavenPublication) {
                from components.java

                artifact sourceJar {
                    classifier "sources"
                }
            }
        }
    }
    afterEvaluate { project ->
        bintray {
            user = project.bintrayUser
            key = project.bintrayApiKey
            publications = ['maven']
            publish = false
            pkg {
                repo = 'maven'
                name = project.name
                userOrg = 'iide'
                licenses = ['Apache-2.0']
                websiteUrl = 'https://github.com/interactive-instruments/XtraPlatform'
                issueTrackerUrl = 'https://github.com/interactive-instruments/XtraPlatform/issues'
                vcsUrl = 'https://github.com/interactive-instruments/XtraPlatform.git'
                githubRepo = 'interactive-instruments/XtraPlatform'
                githubReleaseNotesFile = 'README.md'
                version {
                    name = project.version
                }
            }
        }
    }
}

allprojects {

    group = 'de.interactive_instruments'
    //version += '-SNAPSHOT'


}



configure(subprojects.findAll {it.name != 'xtraplatform-logging-i18n'}) {
    dependencies {
        compile project(':xtraplatform-logging-i18n')
    }
}
